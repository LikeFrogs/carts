pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
function _init()
	--player
	player = {
		sprite = 1,
		x = 16,
		y = 30,
		w = 8,
		h = 8,

		dx = 0,
		dy = 0,

		flip = false,
		falling = false,

		animTime = 0,
	}

	checkPoint = {
		x = 16, 
		y = 30,
	}

	--control variables
	gravity = 0.3
	movementAcceleration = 0.5
	jumpAcceleration = 4
	maxHorizontalSpeed = 3
	maxFallSpeed = 5
	maxJumpSpeed = -4
	friction = 0.85

	--camera
	cam = {
		x = 0,
		y = 0,
	}
end

function _update()
	processPlayerMovement()

	checkCollisions()

	animatePlayer()

	--apply accumulated acceleration
	player.x += player.dx
	player.y += player.dy
	--map edges
	if player.x < 0 then
		player.x = 0
	end

	handleCheckpoint()

	cameraUpdate()
end

function processPlayerMovement()
	--user input
	if btn(0) then 
		player.dx -= movementAcceleration
		player.flip = true
	end
	if btn(1) then 
		player.dx += movementAcceleration
		player.flip = false
	end
	if btn(2) and not player.falling then 
		player.dy -= jumpAcceleration
	end
	if btn(3) and player.falling then 
		player.dy += jumpAcceleration
	end

	--apply gravity and friction
	if not player.falling then
		player.dx *= friction
	end
	player.dy += gravity

	--cap player speeds
	if player.dx > maxHorizontalSpeed then
		player.dx = maxHorizontalSpeed
	end
	if player.dx < -maxHorizontalSpeed then
		player.dx = -maxHorizontalSpeed
	end
	player.dy = mid(maxJumpSpeed, player.dy, maxFallSpeed)
end

function checkCollisions()
	if collideMap(player, "down", 0) and player.falling then
		player.dy = 0
		player.falling = false
		player.y-=((player.y+player.h+1)%8)-1
	else
		player.falling = true
	end

	-- 7 is rainbow
	-- 6 is thunderclouds
	-- 5 is space stuff

	--max speed
	if collideMap(player, "down", 7) then
		maxHorizontalSpeed = 5
	elseif collideMap(player, "down", 6) then
		maxHorizontalSpeed = 1.3
	elseif collideMap(player, "down", 0) then
		maxHorizontalSpeed = 1.9
	end

	--friction
	if collideMap(player, "down", 7) then
		friction = 1
	else
		friction = 0.85
	end

	--gravity
	if collideMap(player, "down", 6) then
		gravity = 0.45
	elseif collideMap(player, "down", 5) then
		gravity = 0.15
	elseif collideMap(player, "down", 0) then
		gravity = 0.3
	end
end

function animatePlayer()
	if btn(0) or btn(1) then
		if time() - player.animTime > .07 then
			player.animTime = time()
			player.sprite += 1
			if player.sprite == 3 then 
				player.sprite = 1
			end
		end
	elseif not player.falling then
		player.sprite = 1		
	end
end

function cameraUpdate()
	cam.x = player.x - 64 + (player.w / 2)
	camera(cam.x, cam.y)
end

function handleCheckpoint()
	if player.y > cam.y + 80 then
		player.x = checkPoint.x
		player.y = checkPoint.y
		player.dx = 0
		player.dy = 0
	end

	if collideMap(player, "down", 1) then
		checkPoint.x = player.x + 8
		checkPoint.y = player.y - 8
	end
end

function collideMap(obj, aim, flag)
	local x=obj.x  local y=obj.y
	local w=obj.w  local h=obj.h
   
	local x1=0	 local y1=0
	local x2=0  local y2=0
   
	if aim=="left" then
	  x1=x-1  y1=y
	  x2=x    y2=y+h-1   
	elseif aim=="right" then
	  x1=x+w-1    y1=y
	  x2=x+w  y2=y+h-1   
	elseif aim=="up" then
	  x1=x+2    y1=y-1
	  x2=x+w-3  y2=y   
	elseif aim=="down" then
	  x1=x+2      y1=y+h
	  x2=x+w-3    y2=y+h
	end
   
	--pixels to tiles
	x1/=8    y1/=8
	x2/=8    y2/=8
   
	if fget(mget(x1,y1), flag)
	or fget(mget(x1,y2), flag)
	or fget(mget(x2,y1), flag)
	or fget(mget(x2,y2), flag) then
	  return true
	else
	  return false
	end   
end

function _draw()
	cls()
	map(0,0)
	spr(player.sprite, player.x, player.y, 1, 1, player.flip)
end

__gfx__
00000000000a00a0000a00a088888888cccccccccc177ccccccccccceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee22222222000000004444444444444444
0000000000a00a0000a00a0088888888cccccccc1777777ccccccccceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee22222222000000004000000400000004
000000000a9999900a99999099999999cccccccc77777777ccccc17ceeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee22222222000000004007700407000004
007007000a9799700a97997099999999cccccccc77777777cccc1777eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee22222222000000004077000400000004
000770000a9999900a999990aaaaaaaacccccccc77777777ccccc17ceeeeeeeee444eeeeeeeeeeeeeeeeeeeeeeeeeeee22222222000000004077000400000004
0007700000aaaa0000aaaa00aaaaaaaacccccccc77777777cccccccceeeeeeeee444eeeeeeeeeeeeeeeeeeeeeeeeeeee22222222000000004007700400000004
0070070000aaaa0000aaaa00bbbbbbbbcccccccc11111111cccccccceeeeeeeee444eeeeeeeeeeeeeeeeeeeeeeeeeeee22222222000000004000000400007004
0000000000a00a000a0000a0bbbbbbbbcccccccccccccccc17cccccceeeeeeeee444eeeeeeeeeeeeeeeeeeeeeeeeeeee22222222000000004000000400000004
55555555500000005516655555166555aaaaaaaa8888888808888888eeeeeeeee444777ddddddddddddddddddddd44ee00000000000000004444444444444444
5555d55550000000166666551666666555555aa5999999998899999900000000e444777ddddddddddddddddddddd44ee00000000000000004000000400000004
555d5555500000006666666666666666555aa555aaaaaaaa899aaaaa00000000e444777ddddddddddddddddddddd44ee00000000000000004000700400000004
5555555550000000666666666666666655aaa555aaaaaaaa89aaaaaa00000000e444777ddddddddddddddddddddd44ee00000000000000004000000400000004
555555555000000066666666666666665555aaa5aaaaaaaa89aaaaaa00000000e444666ddddddddddddddddddddd44ee00000000000000004000000400070004
5555555550000000666666666666666655555aa5aaaaaaaa8899aaaa00000000e444666ddddddddddddddddddddd44ee00000000000000004000000400000004
55555555500000006666666666666666555aa555999999990889999900000000e444444ddddddddddddddddddddd44ee00000000000000004000000400000004
5555555550000000666666661111111155a55555888888880088888800000000e444444ddddddddddddddddddddd44ee00000000000000004444444444444444
88888888000000000000000000ccbb0000000000000000000000000000000000e44444444444444444444444444444ee00000000000000000000000000000000
9999999900000000070000000ccccbb000000000000000000000000000000000e44444444444444444444444444444ee00000000000000000000000000000000
aaaa55550000000000000000ccccbbbb00000000000000000000000000000000e44445eeeeeeeeeeeeeeeeeeee4444ee00000000000000000000000000000000
aaaa55550000000000000000ccccccbb00000000000000000000000000000000e44445eeeeeeeeeeeeeeeeeeee4444ee00000000000000000000000000000000
aaaa55550000000000000000cccccccc00000000000000000000000000000000e44445eeeeeeeeeeeeeeeeeeee4444ee00000000000000000000000000000000
aaaaaaaa0000000000000000cbbccccc00000000000000000000000000000000e44445eeeeeeeeeeeeeeeeeeee4444ee00000000000000000000000000000000
9999999900000000000000000cbbccc000000000000000000000000000000000e44445eeeeeeeeeeeeeeeeeeee4444ee00000000000000000000000000000000
88888888000000000000000000cbcc0000000000000000000000000000000000e44445eeeeeeeeeeeeeeeeeeee4444ee00000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000555555885555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00055588888888885550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00558887777788888855000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05588877888888888885500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05888888888888888888550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58888888888888888888850000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888888555555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58888888555566666666666666655500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05588855566666666666666666666555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00555556666666666666666666666665550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00566666666666666666666666666666555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05666666666666666666666666666666555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05666666666666666666666666666666557755000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
85666666666666666666666666666666555775000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666666666666666666665555566666555575500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555555666665557566666555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555555666665755566666555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555555666665555566666555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55666666666666666666665555566666555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
95666666666666666666666666666666555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
85666666666666666666666666666666555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555566666666666666666666666666555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58888855566666666666666666666666555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58888888855666666666666666666665500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
08888888888555666666666666555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05588888888888555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00055588888888888888850000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000558888888888888850000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000005588888888888550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc5555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc5555d55500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc555d555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc5555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc5555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc5555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc5555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccc5555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888551665550888888888888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888166666558899999999999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9999999966666666899aaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
999999996666666689aaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaaaaaaa6666666689aaaaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaaaaaaa666666668899aaaaaaaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb666666660889999999999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb666666660088888888888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000008100010000000000000100000040004141402121000001000000000000200000010000000000000000000000000000000000000000000000000000000021212100000000000000000000000000212121210000000000000000000000002121212121000000000000000000000021212121000000000000000000000000
2020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002024202000000000000000000000000834323230000000000000000000000000202020200000000000000000000000002020202000000000000000000000000
__map__
07070707070707070707070707070707c1c10404040404040404040404040404040404c2101010101010101010101010101010c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07070707070707070707070707070707c1c10404040404040404040404040404040404c2101010101010101010101010101010c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07070707070707070707070707070707c1040404040404040404040404060404040404c2101010101010101010101010101010c000000000000000002200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07070707070707070e0f070707070707c1040404040604040505050504040404040404c2101010101010101010101010131313c000220000220022000000002200220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07070707070707071e1f070707070707c1040404040404040404040404040404040404c2101010101010101013131310101010c000002300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
070809070b0707070707070707070707c1040404040404040404040404040404040404c2101010101313131010141010101010c000002200000022002200000000220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0718191a1b0707070707070707070707c1040404050505040404040404040404040404c2101010101010101010101010101010c000000000220000000000404142002200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0728292a2b0707070707070707070707c1040404040404040404040404040404040404c2101010101010101010101010101010c000000000000000220000505152535400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0cd0030303030303030303030303030003030303d1121212121212121212001212121212d215151515151515001520606162636400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000707172737400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
